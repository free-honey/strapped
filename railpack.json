{
  "$schema": "https://schema.railpack.com",
  "caches": {
    "cargo-target": {
      "directory": "target",
      "type": "locked"
    }
  },
  "steps": {
    "install_forc": {
      "commands": [
        "export PATH=${HOME}/.fuelup/bin:${PATH}; if ! command -v fuelup >/dev/null 2>&1; then curl -sSf https://install.fuel.network | sh; fi; fuelup toolchain install latest; fuelup default latest",
        "export PATH=${HOME}/.fuelup/bin:${PATH}; forc --version"
      ]
    },
    "build": {
      "inputs": [
        {
          "step": "install_forc"
        },
        {
          "local": true,
          "include": [
            "Cargo.toml",
            "rust-crates/indexer",
            "rust-crates/indexer/Cargo.toml",
            "Cargo.lock"
          ]
        }
      ],
      "caches": [
        "cargo-target"
      ],
      "commands": [
        {
          "src": ".",
          "dest": "."
        },
        "pwd && ls -la",
        "apt-get update && apt-get install -y clang llvm-dev libclang-dev pkg-config",
        "export PATH=${HOME}/.fuelup/bin:${PATH}; cargo build -p indexer --release",
        "mkdir -p bin",
        "cp target/release/indexer ./bin/indexer"
      ]
    }
  },
  "deploy": {
    "inputs": [
      {
        "step": "build",
        "include": [
          "bin/indexer"
        ]
      }
    ],
    "startCommand": "./bin/indexer --test --graphql-url ${GRAPHQL_URL} --port ${PORT} --tracing --block-request-concurrency 10"
  }
}
